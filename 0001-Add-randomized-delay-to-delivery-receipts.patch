From: Signal Android Plus Privacy
Date: Wed Nov 26 2025
Subject: [PATCH] Add randomized delay to all receipts to prevent timing attacks

YES, this was vibe coded

This patch adds a privacy enhancement to Signal Android by introducing a
randomized delay (0.3-5 seconds) before sending delivery, read, and viewed
receipts. This prevents timing correlation attacks where an adversary could
use the precise timing of receipts to infer information about the user's
activity, device, app open state, location, or behavior patterns.

The implementation:
- Uses SecureRandom for cryptographically secure random delay generation
- Adds a delay between 300 and 5000 milliseconds before each receipt
- Leverages the existing JobManager's setInitialDelay() functionality
- Does not affect message receipt or processing, only receipt sending
- Applied consistently to all receipt types (delivery, read, viewed)
- Includes a user preference toggle (enabled by default)
- Can be disabled for users who prefer instant receipts

Security benefits:
- PARTIALLY Prevents timing analysis attacks by decorrelating message events from
  receipt transmission
- Makes it harder for network observers to determine exact message receipt,
  read, or view times
- Adds uncertainty to metadata that could be used for traffic analysis
  or user behavior profiling
- Protects against correlation attacks across multiple receipt types
- Maintains receipt functionality while enhancing privacy

---
 .../jobs/SendDeliveryReceiptJob.java          | 28 ++++++++++++++++++-
 .../jobs/SendReadReceiptJob.java              | 31 +++++++++++++++++++-
 .../jobs/SendViewedReceiptJob.java            | 28 ++++++++++++++++++-
 .../util/TextSecurePreferences.java           | 10 +++++++
 4 files changed, 94 insertions(+), 3 deletions(-)

diff --git a/app/src/main/java/org/thoughtcrime/securesms/jobs/SendDeliveryReceiptJob.java b/app/src/main/java/org/thoughtcrime/securesms/jobs/SendDeliveryReceiptJob.java
index abc123..def456 100644
--- a/app/src/main/java/org/thoughtcrime/securesms/jobs/SendDeliveryReceiptJob.java
+++ b/app/src/main/java/org/thoughtcrime/securesms/jobs/SendDeliveryReceiptJob.java
@@ -19,6 +19,7 @@ import org.thoughtcrime.securesms.recipients.Recipient;
 import org.thoughtcrime.securesms.recipients.RecipientId;
 import org.thoughtcrime.securesms.recipients.RecipientUtil;
 import org.thoughtcrime.securesms.transport.UndeliverableMessageException;
+import org.thoughtcrime.securesms.util.TextSecurePreferences;
 import org.whispersystems.signalservice.api.SignalServiceMessageSender;
 import org.whispersystems.signalservice.api.crypto.ContentHint;
 import org.whispersystems.signalservice.api.crypto.UntrustedIdentityException;
@@ -29,6 +30,7 @@ import org.whispersystems.signalservice.api.push.exceptions.ServerRejectedExcep
 
 import java.io.IOException;
+import java.security.SecureRandom;
 import java.util.Collections;
 import java.util.concurrent.TimeUnit;
 
@@ -43,6 +45,11 @@ public class SendDeliveryReceiptJob extends BaseJob {
 
   private static final String TAG = Log.tag(SendReadReceiptJob.class);
 
+  // Privacy enhancement: randomized delay to prevent timing attacks
+  private static final long MIN_DELAY_MS = 300;
+  private static final long MAX_DELAY_MS = 5000; // 5 seconds
+  private static final SecureRandom secureRandom = new SecureRandom();
+
   private final RecipientId recipientId;
   private final long        messageSentTimestamp;
   private final long        timestamp;
@@ -56,12 +62,32 @@ public class SendDeliveryReceiptJob extends BaseJob {
                            .setLifespan(TimeUnit.DAYS.toMillis(1))
                            .setMaxAttempts(Parameters.UNLIMITED)
                            .setQueue(recipientId.toQueueKey())
+                           .setInitialDelay(getRandomDelayIfEnabled())
                            .build(),
          recipientId,
          messageSentTimestamp,
          messageId,
          System.currentTimeMillis());
   }
+
+  /**
+   * Generates a random delay between MIN_DELAY_MS and MAX_DELAY_MS to prevent timing attacks,
+   * but only if the feature is enabled. This makes it difficult for an adversary to correlate
+   * message receipt with delivery receipt timing.
+   *
+   * @return A random delay in milliseconds if enabled, 0 otherwise
+   */
+  private static long getRandomDelayIfEnabled() {
+    if (!TextSecurePreferences.isReceiptDeliveryDelayEnabled(AppDependencies.getApplication())) {
+      return 0;
+    }
+    long range = MAX_DELAY_MS - MIN_DELAY_MS;
+    return MIN_DELAY_MS + (long)(secureRandom.nextDouble() * range);
+  }
 
   private SendDeliveryReceiptJob(@NonNull Job.Parameters parameters,
                                  @NonNull RecipientId recipientId,

diff --git a/app/src/main/java/org/thoughtcrime/securesms/jobs/SendReadReceiptJob.java b/app/src/main/java/org/thoughtcrime/securesms/jobs/SendReadReceiptJob.java
index def456..ghi789 100644
--- a/app/src/main/java/org/thoughtcrime/securesms/jobs/SendReadReceiptJob.java
+++ b/app/src/main/java/org/thoughtcrime/securesms/jobs/SendReadReceiptJob.java
@@ -34,6 +34,7 @@ import org.whispersystems.signalservice.api.push.exceptions.ServerRejectedExcep
 
 import java.io.IOException;
+import java.security.SecureRandom;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
@@ -48,6 +49,11 @@ public class SendReadReceiptJob extends BaseJob {
 
   static final int MAX_TIMESTAMPS = 500;
 
+  // Privacy enhancement: randomized delay to prevent timing attacks
+  private static final long MIN_DELAY_MS = 300;
+  private static final long MAX_DELAY_MS = 5000; // 5 seconds
+  private static final SecureRandom secureRandom = new SecureRandom();
+
   private static final String KEY_THREAD                  = "thread";
   private static final String KEY_ADDRESS                 = "address";
   private static final String KEY_RECIPIENT               = "recipient";
@@ -67,11 +73,34 @@ public class SendReadReceiptJob extends BaseJob {
                            .setLifespan(TimeUnit.DAYS.toMillis(1))
                            .setMaxAttempts(Parameters.UNLIMITED)
                            .setQueue(recipientId.toQueueKey())
+                           .setInitialDelay(getRandomDelayIfEnabled())
                            .build(),
          threadId,
          recipientId,
          ensureSize(messageSentTimestamps, MAX_TIMESTAMPS),
          ensureSize(messageIds, MAX_TIMESTAMPS),
          System.currentTimeMillis());
   }
+
+  /**
+   * Generates a random delay between MIN_DELAY_MS and MAX_DELAY_MS to prevent timing attacks,
+   * but only if the feature is enabled. This makes it difficult for an adversary to correlate
+   * message read events with read receipt timing.
+   *
+   * @return A random delay in milliseconds if enabled, 0 otherwise
+   */
+  private static long getRandomDelayIfEnabled() {
+    if (!TextSecurePreferences.isReceiptDeliveryDelayEnabled(AppDependencies.getApplication())) {
+      return 0;
+    }
+    long range = MAX_DELAY_MS - MIN_DELAY_MS;
+    return MIN_DELAY_MS + (long)(secureRandom.nextDouble() * range);
+  }
+
+  private SendReadReceiptJob(@NonNull Job.Parameters parameters,

diff --git a/app/src/main/java/org/thoughtcrime/securesms/jobs/SendViewedReceiptJob.java b/app/src/main/java/org/thoughtcrime/securesms/jobs/SendViewedReceiptJob.java
index ghi789..jkl012 100644
--- a/app/src/main/java/org/thoughtcrime/securesms/jobs/SendViewedReceiptJob.java
+++ b/app/src/main/java/org/thoughtcrime/securesms/jobs/SendViewedReceiptJob.java
@@ -36,6 +36,7 @@ import org.whispersystems.signalservice.api.push.exceptions.ServerRejectedExcep
 
 import java.io.IOException;
+import java.security.SecureRandom;
 import java.util.Collections;
 import java.util.LinkedList;
 import java.util.List;
@@ -50,6 +51,11 @@ public class SendViewedReceiptJob extends BaseJob {
 
   private static final String TAG = Log.tag(SendViewedReceiptJob.class);
 
+  // Privacy enhancement: randomized delay to prevent timing attacks
+  private static final long MIN_DELAY_MS = 300;
+  private static final long MAX_DELAY_MS = 5000; // 5 seconds
+  private static final SecureRandom secureRandom = new SecureRandom();
+
   private static final String KEY_THREAD                  = "thread";
   private static final String KEY_ADDRESS                 = "address";
   private static final String KEY_RECIPIENT               = "recipient";
@@ -70,11 +76,31 @@ public class SendViewedReceiptJob extends BaseJob {
              .addConstraint(NetworkConstraint.KEY)
              .setLifespan(TimeUnit.DAYS.toMillis(1))
              .setMaxAttempts(Parameters.UNLIMITED)
+             .setInitialDelay(getRandomDelayIfEnabled())
              .build(),
          threadId,
          recipientId,
          SendReadReceiptJob.ensureSize(messageSentTimestamps, MAX_TIMESTAMPS),
          SendReadReceiptJob.ensureSize(messageIds, MAX_TIMESTAMPS),
          System.currentTimeMillis());
   }
+
+  /**
+   * Generates a random delay between MIN_DELAY_MS and MAX_DELAY_MS to prevent timing attacks,
+   * but only if the feature is enabled. This makes it difficult for an adversary to correlate
+   * message view events with viewed receipt timing.
+   *
+   * @return A random delay in milliseconds if enabled, 0 otherwise
+   */
+  private static long getRandomDelayIfEnabled() {
+    if (!TextSecurePreferences.isReceiptDeliveryDelayEnabled(AppDependencies.getApplication())) {
+      return 0;
+    }
+    long range = MAX_DELAY_MS - MIN_DELAY_MS;
+    return MIN_DELAY_MS + (long)(secureRandom.nextDouble() * range);
+  }
+
+  private SendViewedReceiptJob(@NonNull Parameters parameters,
+
+diff --git a/app/src/main/java/org/thoughtcrime/securesms/util/TextSecurePreferences.java b/app/src/main/java/org/thoughtcrime/securesms/util/TextSecurePreferences.java
+index jkl012..mno345 100644
+--- a/app/src/main/java/org/thoughtcrime/securesms/util/TextSecurePreferences.java
++++ b/app/src/main/java/org/thoughtcrime/securesms/util/TextSecurePreferences.java
+@@ -92,6 +92,7 @@ public class TextSecurePreferences {
+   public  static final String ALWAYS_RELAY_CALLS_PREF          = "pref_turn_only";
+   public  static final String READ_RECEIPTS_PREF               = "pref_read_receipts";
++  public  static final String RECEIPT_DELIVERY_DELAY_PREF      = "pref_receipt_delivery_delay";
+   public  static final String INCOGNITO_KEYBOARD_PREF          = "pref_incognito_keyboard";
+   public  static final String UNAUTHORIZED_RECEIVED            = "pref_unauthorized_received";
+   private static final String SUCCESSFUL_DIRECTORY_PREF        = "pref_successful_directory";
+@@ -417,6 +418,15 @@ public class TextSecurePreferences {
+     setBooleanPreference(context, READ_RECEIPTS_PREF, enabled);
+   }
+ 
++  public static boolean isReceiptDeliveryDelayEnabled(Context context) {
++    return getBooleanPreference(context, RECEIPT_DELIVERY_DELAY_PREF, true);
++  }
++
++  public static void setReceiptDeliveryDelayEnabled(Context context, boolean enabled) {
++    setBooleanPreference(context, RECEIPT_DELIVERY_DELAY_PREF, enabled);
++  }
++
+   public static boolean isTypingIndicatorsEnabled(Context context) {
+     return getBooleanPreference(context, TYPING_INDICATORS, false);
+   }
-- 
2.43.0

